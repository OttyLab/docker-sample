## Summary
This docker compose file launches gitlab and jenkins. For Windows environemnt, named volume is used for permanete data. (Gitlab tries to change the file permission and it fails with Windows volume).

Gitlab accesses storage heavily and running on slow HDD might often cause 502 error. Therefore, SSD system is recommended.

## Pull images

```
docker pull gitlab/gitlab-ce
docker pull jenkins
```

## Gitlab settings (root)
1. Create normal user and jenkins user
2. Create a group (foo)
3. Create a project in foo (foo/bar)
4. Go to Admin area
5. Select Overview, Project
6. Click Edit button of foo/bar project
7. Select Settings, Integrations
8. Check Merge Request events
9. URL: http://jenkins:8080/gitlab-webhook/start, check Merge Request events the click Add webhook

## Gitlab settings (jenkins)
1. Open settings
2. Select SSH Keys and add key generated in Jenkins setting below
3. Select Access Tokens then add a token with api checked


## Jenkins settings
1. `docker exec -it jenkins bash` then `ssh-keygen -t rsa`
2. Create an user
3. Install Gitlab Merge Request Builder plugin
4. In systm settings,
```
    Git Plugin
        configure user.name / user.email
    Gitlab Merge Request Builder:
        Gitlab Host URL: http://gitlab/
        Jenkins Username: jenkins
        Jenkins API Token: Token generated by Gitlab
        Crontab line: H/2 * * * *
        Asignee Filter: blank
        Build Label Filter: blank
```
5. In global security setting
```
        CSRF: uncheck
        Markup: Safe HTML
```
6. Create a new job
7. In job settings,
```
    Genetal
        Check build parameter
        Add string (name: gitlabSourceBranch, default: devel)
        Add string (name: gitlabTargetBranch, default: master)
        Add string (name: gitlabMergeRequestId, default: 0)
    Souce code
        Repository URL: git@gitlab:foo/bar.git
        Cetfiticate: add the key file
        Advanced, name: origin
    Branch to be built
        Branch identifier: refs/remotes/origin/${gitlabSourceBranch}
    Additional:
        Repository name: origin
        Branch to merge: ${gitlabTargetBranch}
        Merge method: default
    Build trigger:
        Check Gitlab Merge Request Builder
        Gitlab Project Path: foo/bar
```

## Tips
Once the docker-compose down then up, Merge Requst Trigger fails. This might be caused Gitlab Merge Request plugin tries to connect Gitlab during boot and it fails, then enters unexpected status (reserch is required). To recover from thi status, do following steps;

1. Wait until Gitlab gets ready
2. Go to Jenkins setting
3. Reload settings

Here's the log of Jenkins;

```
could not start trigger while loading project 'bar'
java.net.ConnectException: Connection refused (Connection refused)
	at java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)
	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
	at java.net.Socket.connect(Socket.java:589)
	at java.net.Socket.connect(Socket.java:538)
	at sun.net.NetworkClient.doConnect(NetworkClient.java:180)
	at sun.net.www.http.HttpClient.openServer(HttpClient.java:463)
	at sun.net.www.http.HttpClient.openServer(HttpClient.java:558)
	at sun.net.www.http.HttpClient.<init>(HttpClient.java:242)
	at sun.net.www.http.HttpClient.New(HttpClient.java:339)
	at sun.net.www.http.HttpClient.New(HttpClient.java:357)
	at sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:1220)
	at sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1156)
	at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1050)
	at sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:984)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1564)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492)
	at org.gitlab.api.http.GitlabHTTPRequestor.parse(GitlabHTTPRequestor.java:324)
	at org.gitlab.api.http.GitlabHTTPRequestor.access$200(GitlabHTTPRequestor.java:28)
	at org.gitlab.api.http.GitlabHTTPRequestor$1.fetch(GitlabHTTPRequestor.java:232)
Caused: java.net.ConnectException: Connection refused (Connection refused)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
	at sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1944)
	at sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1939)
	at java.security.AccessController.doPrivileged(Native Method)
	at sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1938)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1508)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492)
	at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)
	at org.gitlab.api.http.GitlabHTTPRequestor.handleAPIError(GitlabHTTPRequestor.java:369)
	at org.gitlab.api.http.GitlabHTTPRequestor.access$300(GitlabHTTPRequestor.java:28)
	at org.gitlab.api.http.GitlabHTTPRequestor$1.fetch(GitlabHTTPRequestor.java:236)
Caused: java.lang.Error
	at org.gitlab.api.http.GitlabHTTPRequestor$1.fetch(GitlabHTTPRequestor.java:239)
	at org.gitlab.api.http.GitlabHTTPRequestor$1.hasNext(GitlabHTTPRequestor.java:193)
	at org.gitlab.api.http.GitlabHTTPRequestor.getAll(GitlabHTTPRequestor.java:161)
	at org.gitlab.api.GitlabAPI.getProjects(GitlabAPI.java:560)
	at org.jenkinsci.plugins.gitlab.GitlabRepository.getProjectForPath(GitlabRepository.java:101)
	at org.jenkinsci.plugins.gitlab.GitlabRepository.checkState(GitlabRepository.java:42)
	at org.jenkinsci.plugins.gitlab.GitlabRepository.init(GitlabRepository.java:33)
	at org.jenkinsci.plugins.gitlab.GitlabMergeRequestBuilder.build(GitlabMergeRequestBuilder.java:60)
	at org.jenkinsci.plugins.gitlab.GitlabBuildTrigger.start(GitlabBuildTrigger.java:64)
	at org.jenkinsci.plugins.gitlab.GitlabBuildTrigger.start(GitlabBuildTrigger.java:23)
	at hudson.model.AbstractProject.onLoad(AbstractProject.java:325)
	at hudson.model.Project.onLoad(Project.java:98)
	at hudson.model.Items.load(Items.java:372)
	at jenkins.model.Jenkins$17.run(Jenkins.java:3116)
	at org.jvnet.hudson.reactor.TaskGraphBuilder$TaskImpl.run(TaskGraphBuilder.java:169)
	at org.jvnet.hudson.reactor.Reactor.runTask(Reactor.java:282)
	at jenkins.model.Jenkins$7.runTask(Jenkins.java:1090)
	at org.jvnet.hudson.reactor.Reactor$2.run(Reactor.java:210)
	at org.jvnet.hudson.reactor.Reactor$Node.run(Reactor.java:117)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
```
